version: "3.8"

services:
  # Auth Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: bus-ticket-auth-service-prod
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - NOTIFICATION_SERVICE_URL=http://notification-service:3003
    networks:
      - bus-ticket-network-prod
    volumes:
      - ./services/auth-service:/app
      - /app/node_modules

  # Notification Service
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: bus-ticket-notification-service-prod
    environment:
      - NODE_ENV=production
      - PORT=3003
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM}
      - FRONTEND_URL=${FRONTEND_URL}
    networks:
      - bus-ticket-network-prod
    volumes:
      - ./services/notification-service:/app
      - /app/node_modules

  # Trip Service
  trip-service:
    build:
      context: ./services/trip-service
      dockerfile: Dockerfile
    container_name: bus-ticket-trip-service-prod
    environment:
      - NODE_ENV=production
      - PORT=3005
      - SERVICE_NAME=trip-service
      - REDIS_URL=${REDIS_URL}
      - CACHE_TTL=${CACHE_TTL:-600}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_POOL_MIN=${DB_POOL_MIN:-2}
      - DB_POOL_MAX=${DB_POOL_MAX:-10}
    networks:
      - bus-ticket-network-prod
    volumes:
      - ./services/trip-service:/app
      - /app/node_modules

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: bus-ticket-api-gateway-prod
    environment:
      - NODE_ENV=production
      - PORT=3000
      - AUTH_SERVICE_URL=http://auth-service:3001
      - TRIP_SERVICE_URL=http://trip-service:3005
      - NOTIFICATION_SERVICE_URL=http://notification-service:3003
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=${FRONTEND_URL}
    ports:
      - "3000:3000"
    networks:
      - bus-ticket-network-prod
    volumes:
      - ./api-gateway:/app
      - /app/node_modules

networks:
  bus-ticket-network-prod:
    driver: bridge
